<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MQTT Data Display</title>
    <style>
        /* Style definitions here */
    </style>
</head>

<body>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <div>
        <h1>INCUBATOR ANALYZER</h1>
        <!-- Buttons and Inputs here -->
        <div class="grid-container" id="dataGrid">
            <!-- Data items will be displayed here -->
            <div class="data-item" data-label="T1">T1 = 0 °C</div>
            <div class="data-item" data-label="T2">T2 = 0 °C</div>
            <div class="data-item" data-label="T3">T3 = 0 °C</div>
            <div class="data-item" data-label="T4">T4 = 0 °C</div>
            <div class="data-item" data-label="T5">T5 = 0 °C</div>
            <div class="data-item" data-label="TM">TM = 0 °C</div>
            <div class="data-item" data-label="RH">RH = 0 %</div>
            <div class="data-item" data-label="FLOW">FLOW = 0 m/s</div>
            <div class="data-item" data-label="NOISE">NOISE = 0 dB</div>
        </div>
        <br />
        <h2>Saved Data Table</h2>
        <table id="dataTable">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Time</th>
                    <th>T1</th>
                    <th>T2</th>
                    <th>T3</th>
                    <th>T4</th>
                    <th>T5</th>
                    <th>TM</th>
                    <th>RH</th>
                    <th>FLOW</th>
                    <th>NOISE</th>
                </tr>
            </thead>
            <tbody>
                <!-- Saved data will be displayed here -->
            </tbody>
        </table>
    </div>
    <script>
        const topic = "esp32/bismillah";
        const client = mqtt.connect("ws://broker.hivemq.com:8000/mqtt");

        client.on("connect", () => {
            console.log("Connected to MQTT broker");
            client.subscribe(topic, (err) => {
                if (err) {
                    console.error("Subscription error:", err);
                } else {
                    console.log(`Subscribed to topic: ${topic}`);
                }
            });
        });

        client.on("message", (topic, message) => {
            const data = message.toString();
            console.log("Received message:", data);
            updateDisplay(data);
        });

        function updateDisplay(data) {
            console.log("Update Display with data:", data);
            const dataArray = data.split(",");
            const dataGridItems = document.querySelectorAll(".data-item");
            const dataTableBody = document.querySelector("#dataTable tbody");

            dataGridItems.forEach((item) => (item.textContent = ""));

            let newData = {};
            dataArray.forEach((item) => {
                const [label, value] = item.split("=");
                if (label && value) {
                    let unit = "";
                    switch (label) {
                        case "T1":
                        case "T2":
                        case "T3":
                        case "T4":
                        case "T5":
                        case "TM":
                            unit = "°C";
                            break;
                        case "RH":
                            unit = "%";
                            break;
                        case "FLOW":
                            unit = "m/s";
                            break;
                        case "NOISE":
                            unit = "dB";
                            break;
                        default:
                            break;
                    }

                    const dataItem = document.querySelector(`.data-item[data-label="${label}"]`);
                    if (dataItem) {
                        dataItem.textContent = `${label} = ${value} ${unit}`;
                    } else {
                        console.warn(`Element not found for label: ${label}`);
                    }

                    newData[label] = value;
                }
            });

            newData.timestamp = new Date().toLocaleString();
            console.log("New data to save:", newData);
        }
    </script>
</body>

</html>
