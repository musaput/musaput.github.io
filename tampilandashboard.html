<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MQTT Data Display</title>
  <style>
    /* Existing CSS styles */
    .grid-container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-gap: 10px;
      margin-top: 20px;
    }

    .data-item {
      border: 1px solid #ccc;
      padding: 10px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }

    th {
      background-color: #f2f2f2;
    }

    #importBtn {
      display: none;
    }

    .import-button {
      padding: 10px 20px;
      background-color: #007bff;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 10px;
    }

    .import-button:active,
    .import-button:focus {
      outline: none;
      box-shadow: none;
    }

    /* New CSS styles */
    .controls {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 20px;
    }

    .import-controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .timer-controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .timer-controls label,
    .timer-controls input {
      margin: 0;
    }

    #timerDisplay,
    #intervalDisplay {
      margin-top: 10px;
      font-size: 16px;
    }
  </style>
</head>

<body>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <div>
    <h1>INCUBATOR ANALYZER</h1>
    <div class="controls">
      <button id="toggleBtn" class="button-custom">Start Saving Data</button>
      <button id="resetBtn" class="button-custom">Reset Data</button>
      <button id="exportBtn" class="button-custom">Export Data</button>
      <div class="import-controls">
        <input type="file" id="importBtn" accept=".csv" class="import-button" />
        <label for="importBtn" class="import-button">Import Data</label>
        <div class="timer-controls">
          <label for="intervalInput">Set Interval (seconds):</label>
          <input type="text" id="intervalInput" placeholder="30" />
          <label for="timerInput">Set Timer (hh:mm:ss):</label>
          <input type="text" id="timerInput" placeholder="00:05:00" />
        </div>
      </div>
    </div>
    <div id="timerDisplay"></div>
    <div id="intervalDisplay"></div>
    <div class="grid-container" id="dataGrid">
      <!-- Data items will be displayed here -->
      <div class="data-item" data-label="T1">T1 = 0 °C</div>
      <div class="data-item" data-label="T2">T2 = 0 °C</div>
      <div class="data-item" data-label="T3">T3 = 0 °C</div>
      <div class="data-item" data-label="T4">T4 = 0 °C</div>
      <div class="data-item" data-label="T5">T5 = 0 °C</div>
      <div class="data-item" data-label="TM">TM = 0 °C</div>
      <div class="data-item" data-label="RH">RH = 0 %</div>
      <div class="data-item" data-label="FLOW">FLOW = 0 m/s</div>
      <div class="data-item" data-label="NOISE">NOISE = 0 dB</div>
    </div>
    <br />
    <h2>Saved Data Table</h2>
    <table id="dataTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Time</th>
          <th>T1</th>
          <th>T2</th>
          <th>T3</th>
          <th>T4</th>
          <th>T5</th>
          <th>TM</th>
          <th>RH</th>
          <th>FLOW</th>
          <th>NOISE</th>
        </tr>
      </thead>
      <tbody>
        <!-- Saved data will be displayed here -->
      </tbody>
    </table>
  </div>
  <script>
    // JavaScript code remains the same
    const topic = "esp32/bismillah";
    let savingData = false;
    let tableData = [];
    let saveDataInterval = 0;
    let saveDataIntervalTimer = 0;
    let saveDataIntervalTimerSeconds = 0;
    let hasSaved = false;
    let timerInterval;
    let timerSeconds = 0;

    const timerDisplay = document.getElementById("timerDisplay");
    const intervalDisplay = document.getElementById("intervalDisplay");

    function startTimer() {
      const input = document.getElementById("timerInput").value;
      const [hours, minutes, seconds] = input.split(":").map(Number);
      timerSeconds = hours * 3600 + minutes * 60 + seconds;

      saveDataInterval = parseInt(document.getElementById("intervalInput").value, 10) || 0;
      
      saveDataIntervalTimerSeconds = 0;

      saveDataIntervalTimer = setInterval(() => {
        saveDataIntervalTimerSeconds++;
        if (saveDataInterval > 0 && saveDataIntervalTimerSeconds >= saveDataInterval && savingData) {
          hasSaved = false;
          saveDataIntervalTimerSeconds = 0;
        }
        updateIntervalDisplay();
      }, 1000);

      timerInterval = setInterval(() => {
        timerSeconds--;
        if (timerSeconds <= 0) {
          clearInterval(timerInterval);
          clearInterval(saveDataIntervalTimer);
          savingData = false;
          document.getElementById("toggleBtn").textContent = "Start Saving Data";
        }
        displayTimer();
      }, 1000);
    }
    
    function displayTimer() {
      if (timerSeconds >= 0) {
        const hours = Math.floor(timerSeconds / 3600);
        const minutes = Math.floor((timerSeconds % 3600) / 60);
        const seconds = timerSeconds % 60;
        timerDisplay.textContent = `Timer: ${hours
          .toString()
          .padStart(2, "0")}:${minutes.toString().padStart(2, "0")}:${seconds
            .toString()
            .padStart(2, "0")}`;
      } else {
        timerDisplay.textContent = "Timer: 00:00:00";
      }
    }

    function updateIntervalDisplay() {
      const intervalSeconds = saveDataInterval - saveDataIntervalTimerSeconds;
      const minutes = Math.floor(intervalSeconds / 60);
      const seconds = intervalSeconds % 60;
      intervalDisplay.textContent = `Interval: ${minutes.toString().padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
    }

    function updateDisplay(data) {
      const dataArray = data.split(",");
      const dataGridItems = document.querySelectorAll(".data-item");

      const options = {
        day: 'numeric',
        month: 'numeric',
        year: 'numeric',
        hour: 'numeric',
        minute: 'numeric',
        second: 'numeric',
        hour12: false,
      };

      let newData = { timestamp: new Date().toLocaleString('en-US', options) };

      dataArray.forEach((item) => {
        const [label, value] = item.split("=");
        let unit = "";

        switch (label) {
          case "T1": case "T2": case "T3": case "T4": case "T5": case "TM":
            unit = "°C";
            break;
          case "RH":
            unit = "%";
            break;
          case "FLOW":
            unit = "m/s";
            break;
          case "NOISE":
            unit = "dB";
            break;
          default:
            break;
        }

        const dataItem = document.querySelector(`.data-item[data-label="${label}"]`);
        if (dataItem) {
          dataItem.textContent = `${label} = ${value} ${unit}`;
        }

        if (savingData) {
          newData[label] = parseFloat(value);
        }
      });

      if (savingData) {
        if (saveDataInterval == 0 || saveDataIntervalTimerSeconds == 0) {
          tableData.push(newData);
          displayTable();
        } else if (saveDataIntervalTimerSeconds >= saveDataInterval && !hasSaved) {
          hasSaved = true;
          tableData.push(newData);
          displayTable();
        }
      }
    }

    function displayTable() {
      const tableBody = document.querySelector("#dataTable tbody");
      tableBody.innerHTML = "";
      tableData.forEach((row) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${row.timestamp.split(",")[0]}</td>
          <td>${row.timestamp.split(",")[1]}</td>
          <td>${row.T1 || ""}</td>
          <td>${row.T2 || ""}</td>
          <td>${row.T3 || ""}</td>
          <td>${row.T4 || ""}</td>
          <td>${row.T5 || ""}</td>
          <td>${row.TM || ""}</td>
          <td>${row.RH || ""}</td>
          <td>${row.FLOW || ""}</td>
          <td>${row.NOISE || ""}</td>
        `;
        tableBody.appendChild(tr);
      });
    }

    // Add event listeners for buttons and file input
    document.getElementById("toggleBtn").addEventListener("click", () => {
      savingData = !savingData;
      document.getElementById("toggleBtn").textContent = savingData ? "Stop Saving Data" : "Start Saving Data";
      if (savingData) {
        startTimer();
      } else {
        clearInterval(timerInterval);
        clearInterval(saveDataIntervalTimer);
      }
    });

    document.getElementById("resetBtn").addEventListener("click", () => {
      tableData = [];
      displayTable();
      document.getElementById("timerDisplay").textContent = "Timer: 00:00:00";
      document.getElementById("intervalDisplay").textContent = "Interval: 00:00";
      clearInterval(timerInterval);
      clearInterval(saveDataIntervalTimer);
      savingData = false;
      document.getElementById("toggleBtn").textContent = "Start Saving Data";
    });

    document.getElementById("exportBtn").addEventListener("click", () => {
      const csvContent = "data:text/csv;charset=utf-8,"
        + tableData.map(row => [
          row.timestamp.split(",")[0],
          row.timestamp.split(",")[1],
          row.T1 || "",
          row.T2 || "",
          row.T3 || "",
          row.T4 || "",
          row.T5 || "",
          row.TM || "",
          row.RH || "",
          row.FLOW || "",
          row.NOISE || ""
        ].join(",")).join("\n");

      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "data.csv");
      document.body.appendChild(link);
      link.click();
    });

    document.getElementById("importBtn").addEventListener("change", (event) => {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          const content = e.target.result;
          // Handle CSV import
          console.log(content);
        };
        reader.readAsText(file);
      }
    });
  </script>
</body>

</html>
