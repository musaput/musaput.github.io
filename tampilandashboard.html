<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MQTT Data Display</title>
  <style>
    .grid-container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-gap: 10px;
      margin-top: 20px;
    }

    .data-item {
      border: 1px solid #ccc;
      padding: 10px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }

    th {
      background-color: #f2f2f2;
    }

    /* Style for custom file input button */
    #importBtn {
      display: none;
      /* Hide the default file input */
    }

    .import-button {
      padding: 10px 20px;
      background-color: #007bff;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .button-custom {
      padding: 10px 20px;
      background-color: #007bff;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    /* Additional styles for file input button */
    .import-button:active,
    .import-button:focus {
      outline: none;
      box-shadow: none;
    }
  </style>
</head>

<body>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <div>
    <h1>INCUBATOR ANALYZER</h1>
    <button id="toggleBtn" class="button-custom">Start Saving Data</button>
    <button id="resetBtn" class="button-custom">Reset Data</button>
    <button id="exportBtn" class="button-custom">Export Data</button>
    <input type="file" id="importBtn" accept=".csv" class="import-button" />
    <label for="importBtn" class="import-button">Import Data</label>
    <label for="timerInput">Set Interval (seconds):</label>
    <input type="text" id="intervalInput" placeholder="30" />
    <label for="timerInput">Set Timer (hh:mm:ss):</label>
    <input type="text" id="timerInput" placeholder="00:05:00" />
    <div id="timerDisplay"></div>
    <div class="grid-container" id="dataGrid">
      <!-- Data items will be displayed here -->
      <div class="data-item" data-label="T1">T1 = 0 °C</div>
      <div class="data-item" data-label="T2">T2 = 0 °C</div>
      <div class="data-item" data-label="T3">T3 = 0 °C</div>
      <div class="data-item" data-label="T4">T4 = 0 °C</div>
      <div class="data-item" data-label="T5">T5 = 0 °C</div>
      <div class="data-item" data-label="TM">TM = 0 °C</div>
      <div class="data-item" data-label="RH">RH = 0 %</div>
      <div class="data-item" data-label="FLOW">FLOW = 0 m/s</div>
      <div class="data-item" data-label="NOISE">NOISE = 0 dB</div>
    </div>
    <br />
    <h2>Saved Data Table</h2>
    <table id="dataTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Time</th>
          <th>T1</th>
          <th>T2</th>
          <th>T3</th>
          <th>T4</th>
          <th>T5</th>
          <th>TM</th>
          <th>RH</th>
          <th>FLOW</th>
          <th>NOISE</th>
        </tr>
      </thead>
      <tbody>
        <!-- Saved data will be displayed here -->
      </tbody>
    </table>
  </div>
  <script>
    const topic = "esp32/bismillah";
    let savingData = false;
    let tableData = [];
    let saveDataInterval = 0;
    let saveDataIntervalTimer = 0;
    let saveDataIntervalTimerSeconds = 0;
    let hasSaved = false;
    let timerInterval;
    let timerSeconds = 0;

    const timerDisplay = document.getElementById("timerDisplay");

    function startTimer() {
    const input = document.getElementById("timerInput").value;
    const [hours, minutes, seconds] = input.split(":").map(Number);
    timerSeconds = hours * 3600 + minutes * 60 + seconds;

    saveDataInterval = parseInt(document.getElementById("intervalInput").value, 10) || 0; // Default to 0 if not set
    
    saveDataIntervalTimerSeconds = 0;

    saveDataIntervalTimer = setInterval(() => {
        saveDataIntervalTimerSeconds++;
        if (saveDataInterval > 0 && saveDataIntervalTimerSeconds >= saveDataInterval && savingData) {
            hasSaved = false;
            saveDataIntervalTimerSeconds = 0; // Reset the interval timer
        }
    }, 1000);

    timerInterval = setInterval(() => {
        timerSeconds--;
        if (timerSeconds <= 0) {
            clearInterval(timerInterval);
            clearInterval(saveDataIntervalTimer);
            savingData = false;
            document.getElementById("toggleBtn").textContent = "Start Saving Data";
        }
        displayTimer();
    }, 1000);
}

    function displaySaveDataIntervalTimer() {
    const hours = Math.floor(saveDataIntervalTimerSeconds / 3600);
    const minutes = Math.floor((saveDataIntervalTimerSeconds % 3600) / 60);
    const seconds = saveDataIntervalTimerSeconds % 60;
    saveDataIntervalTimerDisplay.textContent = `Interval: ${hours
      .toString()
      .padStart(2, "0")}:${minutes.toString().padStart(2, "0")}:${seconds
        .toString()
        .padStart(2, "0")}`;
} else {
      saveDataIntervalTimerDisplay.textContent = "Interval: 00:00:00";
    }

    function startSaveDataIntervalTimer() {
    saveDataIntervalTimer = setInterval(function () {
        saveDataIntervalTimerSeconds++;
        displaySaveDataIntervalTimer(); // Memperbarui tampilan interval
        saveData();
    }, saveDataInterval * 1000);
}
    
    function displayTimer() {
    if (timerSeconds >= 0) {
        const hours = Math.floor(timerSeconds / 3600);
        const minutes = Math.floor((timerSeconds % 3600) / 60);
        const seconds = timerSeconds % 60;
        timerDisplay.textContent = `Timer: ${hours
          .toString()
          .padStart(2, "0")}:${minutes.toString().padStart(2, "0")}:${seconds
            .toString()
            .padStart(2, "0")}`;
    } else {
        timerDisplay.textContent = "Timer: 00:00:00";
    }
}

function updateDisplay(data) {
    const dataArray = data.split(",");
    const dataGridItems = document.querySelectorAll(".data-item");

    const options = {
        day: 'numeric',
        month: 'numeric',
        year: 'numeric',
        hour: 'numeric',
        minute: 'numeric',
        second: 'numeric',
        hour12: false, 
    };

    let newData = { timestamp: new Date().toLocaleString('en-US', options) };

    dataArray.forEach((item) => {
        const [label, value] = item.split("=");
        let unit = "";

        switch (label) {
            case "T1": case "T2": case "T3": case "T4": case "T5": case "TM":
                unit = "°C";
                break;
            case "RH":
                unit = "%";
                break;
            case "FLOW":
                unit = "m/s";
                break;
            case "NOISE":
                unit = "dB";
                break;
            default:
                break;
        }

        const dataItem = document.querySelector(`.data-item[data-label="${label}"]`);
        if (dataItem) {
            dataItem.textContent = `${label} = ${value} ${unit}`;
        }

        if (savingData) {
            newData[label] = parseFloat(value);
        }
    });

    if (savingData) {
        if (saveDataInterval == 0 || saveDataIntervalTimerSeconds == 0) {
            tableData.push(newData);
            displayTable();
        } else if (saveDataIntervalTimerSeconds >= saveDataInterval && !hasSaved) {
            hasSaved = true;
            tableData.push(newData);
            displayTable();
        }
    }
}

    // function startTimer() {
    //   const input = document.getElementById("timerInput").value;
    //   const [hours, minutes, seconds] = input.split(":").map(Number);
    //   timerSeconds = hours * 3600 + minutes * 60 + seconds;

    //   if (document.getElementById("intervalInput").value == null) {
    //       saveDataInterval = 0;
    //   } else {
    //       saveDataInterval = document.getElementById("intervalInput").value;
    //   }
            
    //         saveDataIntervalTimer = setInterval(() => {
    //             hasSaved = false;
    //             saveDataIntervalTimerSeconds++;
    //         }, 1000);

    //   timerInterval = setInterval(() => {
    //     timerSeconds--;
    //     if (timerSeconds <= 0) {
    //       clearInterval(timerInterval);
    //       clearInterval(saveDataIntervalTimer);
    //       savingData = false;
    //       document.getElementById("toggleBtn").textContent =
    //         "Start Saving Data";
    //     }
    //     displayTimer();
    //   }, 1000);
    // }

    // function displayTimer() {
    //   if (timerSeconds >= 0) {
    //     const hours = Math.floor(timerSeconds / 3600);
    //     const minutes = Math.floor((timerSeconds % 3600) / 60);
    //     const seconds = timerSeconds % 60;
    //     timerDisplay.textContent = `Timer: ${hours
    //       .toString()
    //       .padStart(2, "0")}:${minutes.toString().padStart(2, "0")}:${seconds
    //         .toString()
    //         .padStart(2, "0")}`;
    //   } else {
    //     timerDisplay.textContent = "Timer: 00:00:00";
    //   }
    // }

    // function updateDisplay(data) {
    //   const dataArray = data.split(",");
    //   const dataGridItems = document.querySelectorAll(".data-item");
    //   const dataTableBody = document.querySelector("#dataTable tbody");

    //   dataGridItems.forEach((item) => (item.textContent = ""));

    //   const options = {
    //     day: 'numeric',
    //     month: 'numeric',
    //     year: 'numeric',
    //     hour: 'numeric',
    //     minute: 'numeric',
    //     second: 'numeric',
    //     hour12: false, // Use 24-hour format
    //   };

    //   let newData = { timestamp: new Date().toLocaleString('en-US', options) };

    //   dataArray.forEach((item) => {
    //     const [label, value] = item.split("=");
    //     let unit = "";

    //     switch (label) {
    //       case "T1":
    //       case "T2":
    //       case "T3":
    //       case "T4":
    //       case "T5":
    //       case "TM":
    //         unit = "°C";
    //         break;
    //       case "RH":
    //         unit = "%";
    //         break;
    //       case "FLOW":
    //         unit = "m/s";
    //         break;
    //       case "NOISE":
    //         unit = "dB";
    //         break;
    //       default:
    //         break;
    //     }

    //     const dataItem = document.querySelector(
    //       `.data-item[data-label="${label}"]`
    //     );
    //     if (dataItem) {
    //       dataItem.textContent = `${label} = ${value} ${unit}`;
    //     }

    //     if (savingData) {
    //       newData[label] = parseFloat(value);
    //     }
    //   });

    //   console.log(newData)
      // console.log("INTERVAL SECONDS " + saveDataIntervalTimerSeconds)
    // console.log("MOD " + saveDataIntervalTimerSeconds % saveDataInterval)
            // console.log("SAVED " + hasSaved)

      // if (savingData) {
      //   if (saveDataInterval == 0) {
      //       tableData.push(newData);
      //       displayTable();
      //   } else if (saveDataIntervalTimerSeconds % saveDataInterval == 0 && hasSaved == false) {
      //     hasSaved = true
      //     tableData.push(newData);
      //     displayTable();
      //           }
      //       }
      //   }

    function displayTable() {
      const dataTableBody = document.querySelector("#dataTable tbody");
      dataTableBody.innerHTML = "";
      tableData.forEach((data) => {
        const row = document.createElement("tr");

        const options = {
          day: 'numeric',
          month: 'numeric',
          year: 'numeric',
          hour: 'numeric',
          minute: 'numeric',
          second: 'numeric',
          hour12: false // Use 24-hour format
        };

        // Splitting Timestamp into Date and Time
        const timestamp = new Date(data.timestamp).toLocaleDateString("en-US", options).toString().split(', ');
        const date = timestamp[0];
        const time = timestamp[1];

        // Creating separate cells for Date and Time
        const dateCell = document.createElement("td");
        const timeCell = document.createElement("td");
        dateCell.textContent = date;
        timeCell.textContent = time;

        // Appending cells to the row
        row.appendChild(dateCell);
        row.appendChild(timeCell);

        // Appending other data cells
        for (const key in data) {
          if (key !== "timestamp") {
            const cell = document.createElement("td");
            cell.textContent = data[key];
            row.appendChild(cell);
          }
        }

        dataTableBody.appendChild(row);
      });

      // Save tableData to local storage
      localStorage.setItem("tableData", JSON.stringify(tableData));
    }

    // Load data from local storage on page load
    window.onload = function () {
      const storedData = localStorage.getItem("tableData");
      if (storedData) {
        tableData = JSON.parse(storedData);
        displayTable();
      }
    };

    const clientId = "mqttjs_" + Math.random().toString(16).substr(2, 8);
    const host = "wss://broker.emqx.io:8084/mqtt";
    const options = {
      keepalive: 60,
      clientId: clientId,
      protocolId: "MQTT",
      protocolVersion: 4,
      clean: true,
      reconnectPeriod: 1000,
      connectTimeout: 30 * 1000,
      will: {
        topic: "WillMsg",
        payload: "Connection Closed abnormally..!",
        qos: 0,
        retain: false,
      },
    };

    console.log("Connecting mqtt client");
    const client = mqtt.connect(host, options);
    client.on("error", (err) => {
      console.log("Connection error: ", err);
      client.end();
    });
    client.on("reconnect", () => {
      console.log("Reconnecting...");
    });
    client.on("connect", function () {
      console.log("Connected to MQTT broker");
      client.subscribe(topic, { qos: 0 });
    });

    client.on("message", (topic, message, packet) => {
      console.log(
        `Received Message: ${message.toString()} On topic: ${topic}`
      );
      updateDisplay(message.toString());
    });

    // Generate random float numbers for testing
    function getRandomFloat(min, max) {
      return Math.random() * (max - min) + min;
    }

    // Generate random data string
    function generateRandomDataString() {
      // Random temperature values (T1 to T5)
      let temperatureT1 = getRandomFloat(0, 100);
      let temperatureT2 = getRandomFloat(0, 100);
      let temperatureT3 = getRandomFloat(0, 100);
      let temperatureT4 = getRandomFloat(0, 100);
      let temperatureT5 = getRandomFloat(0, 100);

      // Random MAX6675 temperature value (TM)
      let temperatureMAX6675 = getRandomFloat(0, 100);

      // Random humidity value (RH)
      let humidity = getRandomFloat(0, 100);

      // Random airflow value (ARF)
      let airflowSCMM = getRandomFloat(0, 100);

      // Random noise value (NOISE)
      let db = getRandomFloat(0, 100);

      // Construct the data string
      let dataString = `T1=${temperatureT1.toFixed(2)},`;
      dataString += `T2=${temperatureT2.toFixed(2)},`;
      dataString += `T3=${temperatureT3.toFixed(2)},`;
      dataString += `T4=${temperatureT4.toFixed(2)},`;
      dataString += `T5=${temperatureT5.toFixed(2)},`;
      dataString += `TM=${temperatureMAX6675.toFixed(2)},`;
      dataString += `RH=${humidity.toFixed(2)},`;
      dataString += `FLOW=${airflowSCMM.toFixed(2)},`;
      dataString += `NOISE=${db.toFixed(2)}`;

      updateDisplay(dataString);
    }

    // setInterval(generateRandomDataString, 1000);

    document
      .getElementById("toggleBtn")
      .addEventListener("click", function () {
        if (!savingData) {
          startTimer();
        } else {
          clearInterval(timerInterval);
          clearInterval(saveDataIntervalTimer);
        }
        savingData = !savingData;
        this.textContent = savingData
          ? "Stop Saving Data"
          : "Start Saving Data";
      });

    document
    .getElementById("resetBtn").addEventListener("click", function () {
    clearInterval(timerInterval);
    clearInterval(saveDataIntervalTimer);

    timerSeconds = 0;
    saveDataIntervalTimerSeconds = 0; // Mengatur ulang waktu interval
    displayTimer();
    displaySaveDataIntervalTimer(); // Menampilkan interval yang direset

    savingData = false;
    tableData = [];

    displayTable();
    document.getElementById("toggleBtn").textContent = "Start Saving Data";
});


      // .getElementById("resetBtn")
      // .addEventListener("click", function () {
      //   clearInterval(timerInterval);
      //   clearInterval(saveDataIntervalTimer);
      //   timerSeconds = 0;
      //   displayTimer();
      //   savingData = false;
      //   tableData = [];
      //   displayTable();
      //   document.getElementById("toggleBtn").textContent =
      //     "Start Saving Data";
      // });

    document
      .getElementById("exportBtn")
      .addEventListener("click", function () {
        const csvContent = tableData
          .map((row) => Object.values(row).join(","))
          .join("\n");
        const blob = new Blob([csvContent], {
          type: "text/csv;charset=utf-8;",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "data.csv";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      });

    document.getElementById("importBtn").addEventListener("change", function (e) {
      if (tableData.length == 0) {
        savingData = !savingData;
        generateRandomDataString();
        savingData = !savingData;
      }

      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (event) {
        const csvData = event.target.result;
        // const rows = csvData.split("\n").slice(1); // Skip header row
        const rows = csvData.split("\n");
        tableData = rows.map((row) => {
          const columns = row.split(",");
          let newData = {};
          for (let i = 0; i < columns.length; i++) {
            if (i == 1) {
              continue;
            }
            if (i === 0) {
              // If it's the first column (Date), set it as the "timestamp"
              const timestamp = columns[0] + columns[1]
              const [date, time] = timestamp.split(" "); // Split date and time
              const [day, month, year] = date.split("/").map(Number); // Parse date
              const [hours, minutes, seconds] = time.split(":").map(Number); // Parse time
              // Format date components with leading zeros if needed
              const formattedDate = `${day.toString().padStart(2, '0')}/${month.toString().padStart(2, '0')}/${year}`;

              // Format time components with leading zeros if needed
              const formattedTime = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

              // Combine date and time components
              const formattedTimestamp = `${formattedDate}, ${formattedTime}`;
              
              newData = {
                timestamp: formattedTimestamp
              };
            } else {
              // For other columns, map them to respective keys
              newData[i] = columns[i];
              // const tableKeys = Object.keys(tableData[0] || {}); // Ensure tableData[0] is defined
              // if (i < tableKeys.length) {
              //   newData[tableKeys[i]] = columns[i];
              // }
            }
          }
          return newData;
        });
        displayTable();
      };
      reader.readAsText(file);
      this.value = ""; // Reset the value to allow importing the same file again
    });
  </script>
</body>

</html>
