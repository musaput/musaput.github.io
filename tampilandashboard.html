<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timer and Interval</title>
    <style>
        #timerIntervalContainer {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        #timerDisplay,
        #intervalDisplay {
            font-size: 1.2em;
        }

        .data-item {
            margin-bottom: 5px;
        }

        #dataTable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        #dataTable th, #dataTable td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }

        #dataTable th {
            background-color: #f4f4f4;
        }

        #controls {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div id="controls">
        <input type="text" id="timerInput" placeholder="HH:MM:SS">
        <input type="text" id="intervalInput" placeholder="Interval (seconds)">
        <button id="toggleBtn">Start Saving Data</button>
        <button id="resetBtn">Reset</button>
    </div>
    
    <div id="timerIntervalContainer">
        <div id="timerDisplay">Timer: 00:00:00</div>
        <div id="intervalDisplay">Interval: 00:00:00</div>
    </div>

    <div id="dataDisplay">
        <div class="data-item" data-label="T1"></div>
        <div class="data-item" data-label="T2"></div>
        <div class="data-item" data-label="T3"></div>
        <div class="data-item" data-label="T4"></div>
        <div class="data-item" data-label="T5"></div>
        <div class="data-item" data-label="TM"></div>
        <div class="data-item" data-label="RH"></div>
        <div class="data-item" data-label="FLOW"></div>
        <div class="data-item" data-label="NOISE"></div>
    </div>

    <table id="dataTable">
        <thead>
            <tr>
                <th>Date</th>
                <th>Time</th>
                <th>T1</th>
                <th>T2</th>
                <th>T3</th>
                <th>T4</th>
                <th>T5</th>
                <th>TM</th>
                <th>RH</th>
                <th>FLOW</th>
                <th>NOISE</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script>
        const topic = "esp32/bismillah";
        let savingData = false;
        let tableData = [];
        let saveDataInterval = 0;
        let saveDataIntervalTimer = 0;
        let saveDataIntervalTimerSeconds = 0;
        let hasSaved = false;
        let timerInterval;
        let timerSeconds = 0;

        const timerDisplay = document.getElementById("timerDisplay");
        const intervalDisplay = document.getElementById("intervalDisplay");

        function startTimer() {
            const input = document.getElementById("timerInput").value;
            const [hours, minutes, seconds] = input.split(":").map(Number);
            timerSeconds = hours * 3600 + minutes * 60 + seconds;

            if (document.getElementById("intervalInput").value == null) {
                saveDataInterval = 0;
            } else {
                saveDataInterval = parseInt(document.getElementById("intervalInput").value, 10);
            }
            
            saveDataIntervalTimer = setInterval(() => {
                hasSaved = false;
                saveDataIntervalTimerSeconds++;
                updateIntervalDisplay();
            }, 1000);

            timerInterval = setInterval(() => {
                timerSeconds--;
                if (timerSeconds <= 0) {
                    clearInterval(timerInterval);
                    clearInterval(saveDataIntervalTimer);
                    savingData = false;
                    document.getElementById("toggleBtn").textContent = "Start Saving Data";
                }
                displayTimer();
            }, 1000);
        }

        function displayTimer() {
            if (timerSeconds >= 0) {
                const hours = Math.floor(timerSeconds / 3600);
                const minutes = Math.floor((timerSeconds % 3600) / 60);
                const seconds = timerSeconds % 60;
                timerDisplay.textContent = `Timer: ${hours.toString().padStart(2, "0")}:${minutes.toString().padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
            } else {
                timerDisplay.textContent = "Timer: 00:00:00";
            }
        }

        function updateIntervalDisplay() {
            const intervalSeconds = saveDataIntervalTimerSeconds % saveDataInterval;
            const hours = Math.floor(intervalSeconds / 3600);
            const minutes = Math.floor((intervalSeconds % 3600) / 60);
            const seconds = intervalSeconds % 60;
            intervalDisplay.textContent = `Interval: ${hours.toString().padStart(2, "0")}:${minutes.toString().padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
        }

        function updateDisplay(data) {
            const dataArray = data.split(",");
            const dataGridItems = document.querySelectorAll(".data-item");
            const dataTableBody = document.querySelector("#dataTable tbody");

            dataGridItems.forEach((item) => (item.textContent = ""));

            const options = {
                day: 'numeric',
                month: 'numeric',
                year: 'numeric',
                hour: 'numeric',
                minute: 'numeric',
                second: 'numeric',
                hour12: false,
            };

            let newData = { timestamp: new Date().toLocaleString('en-US', options) };

            dataArray.forEach((item) => {
                const [label, value] = item.split("=");
                let unit = "";

                switch (label) {
                    case "T1":
                    case "T2":
                    case "T3":
                    case "T4":
                    case "T5":
                    case "TM":
                        unit = "Â°C";
                        break;
                    case "RH":
                        unit = "%";
                        break;
                    case "FLOW":
                        unit = "m/s";
                        break;
                    case "NOISE":
                        unit = "dB";
                        break;
                    default:
                        break;
                }

                const dataItem = document.querySelector(`.data-item[data-label="${label}"]`);
                if (dataItem) {
                    dataItem.textContent = `${label} = ${value} ${unit}`;
                }

                if (savingData) {
                    newData[label] = parseFloat(value);
                }
            });

            if (savingData) {
                if (saveDataInterval == 0) {
                    tableData.push(newData);
                    displayTable();
                } else if (saveDataIntervalTimerSeconds % saveDataInterval == 0 && hasSaved == false) {
                    hasSaved = true;
                    tableData.push(newData);
                    displayTable();
                }
            }
        }

        function displayTable() {
            const dataTableBody = document.querySelector("#dataTable tbody");
            dataTableBody.innerHTML = "";
            tableData.forEach((data) => {
                const row = document.createElement("tr");

                const options = {
                    day: 'numeric',
                    month: 'numeric',
                    year: 'numeric',
                    hour: 'numeric',
                    minute: 'numeric',
                    second: 'numeric',
                    hour12: false
                };

                const timestamp = new Date(data.timestamp).toLocaleDateString("en-US", options).toString().split(', ');
                const date = timestamp[0];
                const time = timestamp[1];

                const dateCell = document.createElement("td");
                const timeCell = document.createElement("td");
                dateCell.textContent = date;
                timeCell.textContent = time;

                row.appendChild(dateCell);
                row.appendChild(timeCell);

                for (const key in data) {
                    if (key !== "timestamp") {
                        const cell = document.createElement("td");
                        cell.textContent = data[key];
                        row.appendChild(cell);
                    }
                }

                dataTableBody.appendChild(row);
            });

            localStorage.setItem("tableData", JSON.stringify(tableData));
        }

        window.onload = function () {
            const storedData = localStorage.getItem("tableData");
            if (storedData) {
                tableData = JSON.parse(storedData);
                displayTable();
            }
        };

        const clientId = "mqttjs_" + Math.random().toString(16).substr(2, 8);
        const host = "wss://broker.emqx.io:8084/mqtt";
        const options = {
            keepalive: 60,
            clientId: clientId,
        };

        const client = mqtt.connect(host, options);

        client.on("connect", () => {
            client.subscribe(topic, (err) => {
                if (err) {
                    console.error("Subscription error:", err);
                }
            });
        });

        client.on("message", (topic, message) => {
            const dataString = message.toString();
            updateDisplay(dataString);
        });

        document.getElementById("toggleBtn").addEventListener("click", () => {
            if (savingData) {
                savingData = false;
                document.getElementById("toggleBtn").textContent = "Start Saving Data";
                clearInterval(timerInterval);
                clearInterval(saveDataIntervalTimer);
            } else {
                savingData = true;
                document.getElementById("toggleBtn").textContent = "Stop Saving Data";
                startTimer();
            }
        });

        document.getElementById("resetBtn").addEventListener("click", () => {
            // Reset data table
            tableData = [];
            displayTable();

            // Clear local storage
            localStorage.removeItem("tableData");

            // Stop saving data and clear intervals
            savingData = false;
            document.getElementById("toggleBtn").textContent = "Start Saving Data";

            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }

            if (saveDataIntervalTimer) {
                clearInterval(saveDataIntervalTimer);
                saveDataIntervalTimer = null;
            }

            // Reset timer and interval display
            timerDisplay.textContent = "Timer: 00:00:00";
            intervalDisplay.textContent = "Interval: 00:00:00";

            // Clear input values
            document.getElementById("timerInput").value = "";
            document.getElementById("intervalInput").value = "";
        });
    </script>
</body>
</html>
