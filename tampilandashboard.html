<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MQTT Data Display</title>
    <style>
        .grid-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-gap: 10px;
            margin-top: 20px;
        }

        .data-item {
            border: 1px solid #ccc;
            padding: 10px;
        }

        table {
            border-collapse: collapse;
            width: 100%;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        #importBtn {
            display: none;
        }

        .import-button,
        .button-custom {
            padding: 10px 20px;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .import-button:active,
        .import-button:focus,
        .button-custom:active,
        .button-custom:focus {
            outline: none;
            box-shadow: none;
        }

        #timerDisplay,
        #intervalDisplay {
            font-size: 1.2em;
            margin: 10px 0;
        }
    </style>
</head>

<body>
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <div>
        <h1>INCUBATOR ANALYZER</h1>
        <button id="toggleBtn" class="button-custom">Start Saving Data</button>
        <button id="resetBtn" class="button-custom">Reset Data</button>
        <button id="exportBtn" class="button-custom">Export Data</button>
        <input type="file" id="importBtn" accept=".csv" class="import-button" />
        <label for="importBtn" class="import-button">Import Data</label>
        <label for="intervalInput">Set Interval (seconds):</label>
        <input type="text" id="intervalInput" placeholder="30" />
        <label for="timerInput">Set Timer (hh:mm:ss):</label>
        <input type="text" id="timerInput" placeholder="00:05:00" />
        <div id="timerDisplay">Timer: 00:00:00</div>
        <div id="intervalDisplay">Interval Timer: 00:00:00</div>
        <div class="grid-container" id="dataGrid">
            <!-- Data items will be displayed here -->
            <div class="data-item" data-label="T1">T1 = 0 °C</div>
            <div class="data-item" data-label="T2">T2 = 0 °C</div>
            <div class="data-item" data-label="T3">T3 = 0 °C</div>
            <div class="data-item" data-label="T4">T4 = 0 °C</div>
            <div class="data-item" data-label="T5">T5 = 0 °C</div>
            <div class="data-item" data-label="TM">TM = 0 °C</div>
            <div class="data-item" data-label="RH">RH = 0 %</div>
            <div class="data-item" data-label="FLOW">FLOW = 0 m/s</div>
            <div class="data-item" data-label="NOISE">NOISE = 0 dB</div>
        </div>
        <br />
        <h2>Saved Data Table</h2>
        <table id="dataTable">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Time</th>
                    <th>T1</th>
                    <th>T2</th>
                    <th>T3</th>
                    <th>T4</th>
                    <th>T5</th>
                    <th>TM</th>
                    <th>RH</th>
                    <th>FLOW</th>
                    <th>NOISE</th>
                </tr>
            </thead>
            <tbody>
                <!-- Saved data will be displayed here -->
            </tbody>
        </table>
    </div>
    <script>
        const topic = "esp32/bismillah";
        let savingData = false;
        let tableData = [];
        let timerSeconds = 0;
        let intervalSeconds = 0;
        let intervalCounter = 0;
        let timerInterval;
        let intervalInterval;
        const timerDisplay = document.getElementById("timerDisplay");
        const intervalDisplay = document.getElementById("intervalDisplay");

        function startTimer() {
            // Get timer and interval input values
            const timerInput = document.getElementById("timerInput").value;
            const [hours, minutes, seconds] = timerInput.split(":").map(Number);
            timerSeconds = hours * 3600 + minutes * 60 + seconds;

            const intervalInput = document.getElementById("intervalInput").value;
            intervalSeconds = parseInt(intervalInput, 10) || 0;
            intervalCounter = 0;

            clearInterval(timerInterval);
            clearInterval(intervalInterval);

            intervalInterval = setInterval(() => {
                intervalCounter++;
                if (intervalCounter % intervalSeconds === 0) {
                    updateIntervalDisplay();
                }
            }, 1000);

            timerInterval = setInterval(() => {
                timerSeconds--;
                if (timerSeconds <= 0) {
                    clearInterval(timerInterval);
                    clearInterval(intervalInterval);
                    savingData = false;
                    document.getElementById("toggleBtn").textContent = "Start Saving Data";
                }
                displayTimer();
            }, 1000);
        }

        function displayTimer() {
            if (timerSeconds >= 0) {
                const hours = Math.floor(timerSeconds / 3600);
                const minutes = Math.floor((timerSeconds % 3600) / 60);
                const seconds = timerSeconds % 60;
                timerDisplay.textContent = `Timer: ${hours.toString().padStart(2, "0")}:${minutes.toString().padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
            } else {
                timerDisplay.textContent = "Timer: 00:00:00";
            }
        }

        function updateIntervalDisplay() {
            const hours = Math.floor(intervalCounter / 3600);
            const minutes = Math.floor((intervalCounter % 3600) / 60);
            const seconds = intervalCounter % 60;
            intervalDisplay.textContent = `Interval Timer: ${hours.toString().padStart(2, "0")}:${minutes.toString().padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;
        }

        function displayTable() {
            const dataTableBody = document.querySelector("#dataTable tbody");
            dataTableBody.innerHTML = "";
            tableData.forEach((data) => {
                const row = document.createElement("tr");

                // Splitting Timestamp into Date and Time
                const timestamp = new Date(data.timestamp).toLocaleDateString("en-US").split(', ');
                const date = timestamp[0];
                const time = timestamp[1];

                // Creating separate cells for Date and Time
                const dateCell = document.createElement("td");
                const timeCell = document.createElement("td");
                dateCell.textContent = date;
                timeCell.textContent = time;

                // Appending cells to the row
                row.appendChild(dateCell);
                row.appendChild(timeCell);

                // Appending other data cells
                for (const key in data) {
                    if (key !== "timestamp") {
                        const cell = document.createElement("td");
                        cell.textContent = data[key];
                        row.appendChild(cell);
                    }
                }

                dataTableBody.appendChild(row);
            });

            // Save tableData to local storage
            localStorage.setItem("tableData", JSON.stringify(tableData));
        }

        window.onload = function () {
            const storedData = localStorage.getItem("tableData");
            if (storedData) {
                tableData = JSON.parse(storedData);
                displayTable();
            }
        };

        const clientId = "mqttjs_" + Math.random().toString(16).substr(2, 8);
        const host = "wss://broker.emqx.io:8084/mqtt";
        const options = {
            keepalive: 60,
            clientId: clientId,
            protocolId: "MQTT",
            protocolVersion: 4,
            clean: true,
            reconnectPeriod: 1000,
            connectTimeout: 30 * 1000,
            will: {
                topic: "WillMsg",
                payload: "Connection Closed abnormally..!",
                qos: 0,
                retain: false,
            },
        };

        console.log("Connecting mqtt client");
        const client = mqtt.connect(host, options);
        client.on("error", (err) => {
            console.log("Connection error: ", err);
            client.end();
        });
        client.on("close", () => {
            console.log("Connection closed");
        });
        client.on("connect", () => {
            console.log("Connected");
            client.subscribe(topic, (err) => {
                if (!err) {
                    console.log(`Subscribed to topic ${topic}`);
                }
            });
        });

        client.on("message", (topic, message) => {
            const data = message.toString();
            const jsonData = JSON.parse(data);

            // Update display with MQTT data
            document.querySelector(`.data-item[data-label="T1"]`).textContent = `T1 = ${jsonData.T1} °C`;
            document.querySelector(`.data-item[data-label="T2"]`).textContent = `T2 = ${jsonData.T2} °C`;
            document.querySelector(`.data-item[data-label="T3"]`).textContent = `T3 = ${jsonData.T3} °C`;
            document.querySelector(`.data-item[data-label="T4"]`).textContent = `T4 = ${jsonData.T4} °C`;
            document.querySelector(`.data-item[data-label="T5"]`).textContent = `T5 = ${jsonData.T5} °C`;
            document.querySelector(`.data-item[data-label="TM"]`).textContent = `TM = ${jsonData.TM} °C`;
            document.querySelector(`.data-item[data-label="RH"]`).textContent = `RH = ${jsonData.RH} %`;
            document.querySelector(`.data-item[data-label="FLOW"]`).textContent = `FLOW = ${jsonData.FLOW} m/s`;
            document.querySelector(`.data-item[data-label="NOISE"]`).textContent = `NOISE = ${jsonData.NOISE} dB`;

            // Save data to tableData
            tableData.push({
                timestamp: new Date(),
                T1: jsonData.T1,
                T2: jsonData.T2,
                T3: jsonData.T3,
                T4: jsonData.T4,
                T5: jsonData.T5,
                TM: jsonData.TM,
                RH: jsonData.RH,
                FLOW: jsonData.FLOW,
                NOISE: jsonData.NOISE,
            });

            // Display updated table
            displayTable();
        });

        document.getElementById("toggleBtn").addEventListener("click", function () {
            if (!savingData) {
                startTimer();
            } else {
                clearInterval(timerInterval);
                clearInterval(intervalInterval);
                displayTimer();
                displayInterval();
            }
            savingData = !savingData;
            this.textContent = savingData ? "Stop Saving Data" : "Start Saving Data";
        });

        document.getElementById("resetBtn").addEventListener("click", () => {
            clearInterval(timerInterval);
            clearInterval(intervalInterval);
            timerSeconds = 0;
            intervalCounter = 0;
            displayTimer();
            displayInterval();
            tableData = [];
            document.querySelector("#dataTable tbody").innerHTML = "";
        });

        document.getElementById("exportBtn").addEventListener("click", () => {
            const csvContent = "data:text/csv;charset=utf-8," +
                tableData.map(row => {
                    const rowArray = [
                        new Date(row.timestamp).toLocaleDateString(),
                        new Date(row.timestamp).toLocaleTimeString(),
                        row.T1,
                        row.T2,
                        row.T3,
                        row.T4,
                        row.T5,
                        row.TM,
                        row.RH,
                        row.FLOW,
                        row.NOISE
                    ];
                    return rowArray.join(",");
                }).join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "saved_data.csv");
            document.body.appendChild(link);

            link.click();
        });

        document.getElementById("importBtn").addEventListener("change", (event) => {
            const file = event.target.files[0];
            const reader = new FileReader();

            reader.onload = (e) => {
                const contents = e.target.result;
                const rows = contents.split("\n");
                tableData = rows.slice(1).map(row => {
                    const values = row.split(",");
                    return {
                        timestamp: new Date(values[0] + ' ' + values[1]),
                        T1: parseFloat(values[2]),
                        T2: parseFloat(values[3]),
                        T3: parseFloat(values[4]),
                        T4: parseFloat(values[5]),
                        T5: parseFloat(values[6]),
                        TM: parseFloat(values[7]),
                        RH: parseFloat(values[8]),
                        FLOW: parseFloat(values[9]),
                        NOISE: parseFloat(values[10]),
                    };
                });

                displayTable();
            };

            reader.readAsText(file);
        });
    </script>
</body>

</html>
