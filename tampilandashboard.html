<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MQTT Data Display</title>
  <style>
    .grid-container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-gap: 10px;
      margin-top: 20px;
    }

    .data-item {
      border: 1px solid #ccc;
      padding: 10px;
    }

    table {
      border-collapse: collapse;
      width: 100%;
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }

    th {
      background-color: #f2f2f2;
    }

    #importBtn {
      display: none;
    }

    .import-button,
    .button-custom {
      padding: 10px 20px;
      background-color: #007bff;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .import-button:active,
    .import-button:focus,
    .button-custom:active,
    .button-custom:focus {
      outline: none;
      box-shadow: none;
    }

    .timer-container {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 20px 0;
    }

    .timer-display {
      font-size: 1.5em;
      font-weight: bold;
    }
  </style>
</head>

<body>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <div>
    <h1>INCUBATOR ANALYZER</h1>
    <button id="toggleBtn" class="button-custom">Start Saving Data</button>
    <button id="resetBtn" class="button-custom">Reset Data</button>
    <button id="exportBtn" class="button-custom">Export Data</button>
    <input type="file" id="importBtn" accept=".csv" class="import-button" />
    <label for="importBtn" class="import-button">Import Data</label>
    <div class="timer-container">
      <div>
        <label for="intervalInput">Set Interval (seconds):</label>
        <input type="text" id="intervalInput" placeholder="30" />
      </div>
      <div>
        <label for="timerInput">Set Timer (hh:mm:ss):</label>
        <input type="text" id="timerInput" placeholder="00:05:00" />
      </div>
    </div>
    <div class="timer-container">
      <div id="intervalDisplay" class="timer-display">Interval: 00:00:00</div>
      <div id="timerDisplay" class="timer-display">Timer: 00:00:00</div>
    </div>
    <div class="grid-container" id="dataGrid">
      <!-- Data items will be displayed here -->
      <div class="data-item" data-label="T1">T1 = 0 °C</div>
      <div class="data-item" data-label="T2">T2 = 0 °C</div>
      <div class="data-item" data-label="T3">T3 = 0 °C</div>
      <div class="data-item" data-label="T4">T4 = 0 °C</div>
      <div class="data-item" data-label="T5">T5 = 0 °C</div>
      <div class="data-item" data-label="TM">TM = 0 °C</div>
      <div class="data-item" data-label="RH">RH = 0 %</div>
      <div class="data-item" data-label="FLOW">FLOW = 0 m/s</div>
      <div class="data-item" data-label="NOISE">NOISE = 0 dB</div>
    </div>
    <br />
    <h2>Saved Data Table</h2>
    <table id="dataTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Time</th>
          <th>T1</th>
          <th>T2</th>
          <th>T3</th>
          <th>T4</th>
          <th>T5</th>
          <th>TM</th>
          <th>RH</th>
          <th>FLOW</th>
          <th>NOISE</th>
        </tr>
      </thead>
      <tbody>
        <!-- Saved data will be displayed here -->
      </tbody>
    </table>
  </div>
  <script>
    const topic = "esp32/bismillah";
    let savingData = false;
    let tableData = [];
    let saveDataInterval = 0;
    let saveDataIntervalTimer = 0;
    let saveDataIntervalTimerSeconds = 0;
    let timerInterval;
    let timerSeconds = 0;

    const timerDisplay = document.getElementById("timerDisplay");
    const intervalDisplay = document.getElementById("intervalDisplay");

    function startTimer() {
      const timerInput = document.getElementById("timerInput").value;
      const intervalInput = document.getElementById("intervalInput").value;
      const [hours, minutes, seconds] = timerInput.split(":").map(Number);
      timerSeconds = hours * 3600 + minutes * 60 + seconds;
      saveDataInterval = parseInt(intervalInput, 10) || 0;

      saveDataIntervalTimerSeconds = 0;

      saveDataIntervalTimer = setInterval(() => {
        saveDataIntervalTimerSeconds++;
        displayInterval();
      }, 1000);

      timerInterval = setInterval(() => {
        timerSeconds--;
        if (timerSeconds <= 0) {
          clearInterval(timerInterval);
          clearInterval(saveDataIntervalTimer);
          savingData = false;
          document.getElementById("toggleBtn").textContent = "Start Saving Data";
        }
        displayTimer();
      }, 1000);
    }

    function displayTimer() {
      if (timerSeconds >= 0) {
        const hours = Math.floor(timerSeconds / 3600);
        const minutes = Math.floor((timerSeconds % 3600) / 60);
        const seconds = timerSeconds % 60;
        timerDisplay.textContent = `Timer: ${hours
          .toString()
          .padStart(2, "0")}:${minutes.toString().padStart(2, "0")}:${seconds
            .toString()
            .padStart(2, "0")}`;
      } else {
        timerDisplay.textContent = "Timer: 00:00:00";
      }
    }

    function displayInterval() {
      if (saveDataInterval > 0) {
        const hours = Math.floor(saveDataIntervalTimerSeconds / 3600);
        const minutes = Math.floor((saveDataIntervalTimerSeconds % 3600) / 60);
        const seconds = saveDataIntervalTimerSeconds % 60;
        intervalDisplay.textContent = `Interval: ${hours
          .toString()
          .padStart(2, "0")}:${minutes.toString().padStart(2, "0")}:${seconds
            .toString()
            .padStart(2, "0")}`;
      } else {
        intervalDisplay.textContent = "Interval: 00:00:00";
      }
    }

    function updateDisplay(data) {
      const dataArray = data.split(",");
      const dataGridItems = document.querySelectorAll(".data-item");

      const options = {
        day: 'numeric',
        month: 'numeric',
        year: 'numeric',
        hour: 'numeric',
        minute: 'numeric',
        second: 'numeric',
        hour12: false, 
      };

      let newData = { timestamp: new Date().toLocaleString('en-US', options) };

      dataArray.forEach((item) => {
        const [label, value] = item.split("=");
        let unit = "";

        switch (label) {
          case "T1": case "T2": case "T3": case "T4": case "T5": case "TM":
            unit = "°C";
            break;
          case "RH":
            unit = "%";
            break;
          case "FLOW":
            unit = "m/s";
            break;
          case "NOISE":
            unit = "dB";
            break;
          default:
            break;
        }

        newData[label] = value.trim() + unit;
      });

      dataGridItems.forEach((item) => {
        const label = item.getAttribute("data-label");
        if (newData[label]) {
          item.textContent = `${label} = ${newData[label]}`;
        }
      });

      if (savingData) {
        tableData.push(newData);
        displayTable();
      }
    }

    function displayTable() {
      const tableBody = document.querySelector("#dataTable tbody");
      tableBody.innerHTML = "";

      tableData.forEach((data) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${data.timestamp}</td>
          <td>${data.timestamp}</td>
          <td>${data.T1 || ""}</td>
          <td>${data.T2 || ""}</td>
          <td>${data.T3 || ""}</td>
          <td>${data.T4 || ""}</td>
          <td>${data.T5 || ""}</td>
          <td>${data.TM || ""}</td>
          <td>${data.RH || ""}</td>
          <td>${data.FLOW || ""}</td>
          <td>${data.NOISE || ""}</td>
        `;
        tableBody.appendChild(row);
      });
    }

    function exportData() {
      const csvRows = [];
      const headers = [
        "Date",
        "Time",
        "T1",
        "T2",
        "T3",
        "T4",
        "T5",
        "TM",
        "RH",
        "FLOW",
        "NOISE"
      ];
      csvRows.push(headers.join(","));

      tableData.forEach((row) => {
        const values = headers.map(header => row[header] || "");
        csvRows.push(values.join(","));
      });

      const csvData = csvRows.join("\n");
      const blob = new Blob([csvData], { type: "text/csv" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "data.csv";
      a.click();
    }

    function importData(file) {
      const reader = new FileReader();

      reader.onload = (event) => {
        const csv = event.target.result;
        const lines = csv.split("\n");
        const headers = lines[0].split(",");

        tableData = lines.slice(1).map(line => {
          const values = line.split(",");
          const row = {};
          headers.forEach((header, index) => {
            row[header] = values[index];
          });
          return row;
        });

        displayTable();
      };

      reader.readAsText(file);
    }

    document.getElementById("toggleBtn").addEventListener("click", () => {
      savingData = !savingData;
      if (savingData) {
        startTimer();
        document.getElementById("toggleBtn").textContent = "Stop Saving Data";
      } else {
        clearInterval(timerInterval);
        clearInterval(saveDataIntervalTimer);
        document.getElementById("toggleBtn").textContent = "Start Saving Data";
      }
    });

document.getElementById("resetBtn").addEventListener("click", () => {
  // Hentikan interval timer
  if (timerInterval) {
    clearInterval(timerInterval);
  }

  // Hentikan interval untuk waktu set interval
  if (saveDataIntervalTimer) {
    clearInterval(saveDataIntervalTimer);
  }

  // Setel ulang status savingData
  savingData = false;

  // Kosongkan data yang tersimpan
  tableData = [];

  // Perbarui tampilan tabel
  displayTable();

  // Atur teks tombol toggle kembali ke "Start Saving Data"
  document.getElementById("toggleBtn").textContent = "Start Saving Data";

  // // Reset tampilan waktu interval dan timer
  // intervalDisplay.textContent = "Interval: 00:00:00";
  // timerDisplay.textContent = "Timer: 00:00:00";
});

    document.getElementById("exportBtn").addEventListener("click", () => {
      exportData();
    });

    document.getElementById("importBtn").addEventListener("change", (event) => {
      const file = event.target.files[0];
      if (file) {
        importData(file);
      }
    });

    // Sample MQTT connection and data handling
    const client = mqtt.connect("ws://broker.mqttdashboard.com:8000/mqtt");

    client.on("connect", () => {
      client.subscribe(topic);
    });

    client.on("message", (topic, message) => {
      updateDisplay(message.toString());
    });
  </script>
</body>

</html>
